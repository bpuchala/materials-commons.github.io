<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for mcapi/db/model/users.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../../prettify.css" />
    <link rel="stylesheet" href="../../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../../index.html">all files</a> / <a href="index.html">mcapi/db/model/</a> users.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">27.06% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>23/85</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">5.56% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>1/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">27.78% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>5/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">34.92% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>22/63</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">261×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">261×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const r = require('../r');
const _ = require('lodash');
const getSingle = require('./get-single');
const model = require('./model');
&nbsp;
// getUsers returns all the users in the database. Internal use only
function* getUsers() {
    return r.table('users');
}
&nbsp;
// getAllUsersExternal returns all the users in the database; cleaned for external only
function* getAllUsersExternal() {
    return yield r.table('users').without('admin', 'isTemplateAdmin', 'apikey', 'password');
}
&nbsp;
// getUser gets the user by index. If no index is given then it
// uses the primary key.
<span class="cstat-no" title="statement not covered" >function* getUser(id, index) {</span>
    if (<span class="missing-if-branch" title="else path not taken" >E</span>index) {
        let matches = yield <span class="cstat-no" title="statement not covered" >r.table('users').getAll(id, {index: index}).run();</span>
        if (<span class="cstat-no" title="statement not covered" >matches.length !== 0) {</span>
            return <span class="cstat-no" title="statement not covered" >matches[0];</span>
        }
        return <span class="cstat-no" title="statement not covered" >null;</span>
    }
    return yield r.table('users').get(id).run();
}
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >function* updateProjectFavorites(userID, projectID, attrs) {</span></span></span></span></span></span>
    if (<span class="cstat-no" title="statement not covered" >attrs.favorites) {</span>
        // TODO: validate the projectID exists
        let user = yield <span class="cstat-no" title="statement not covered" >r.table('users').get(userID);</span>
        if (<span class="cstat-no" title="statement not covered" >!user.favorites) {</span>
            user.<span class="cstat-no" title="statement not covered" >favorites = {};</span>
        }
&nbsp;
        if (<span class="cstat-no" title="statement not covered" >!(projectID in user.favorites)) {</span>
            user.<span class="cstat-no" title="statement not covered" >favorites[projectID] = {</span>
                processes: []
            };
        }
&nbsp;
        let toAdd = attrs.favorites.processes.filter(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >p.command === 'add').map(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >p.name);</span></span></span></span>
        let toDelete = attrs.favorites.processes.filter(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >p.command === 'delete').map(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >p.name);</span></span></span></span>
        let projProcesses = user.favorites[projectID].processes;
        // remove deleted process favorites
        projProcesses = <span class="cstat-no" title="statement not covered" >projProcesses.filter(<span class="fstat-no" title="function not covered" >p =&gt; <span class="cstat-no" title="statement not covered" >_.indexOf(toDelete, <span class="fstat-no" title="function not covered" >name =&gt; <span class="cstat-no" title="statement not covered" >name == p, null) === -1);</span></span></span></span></span>
        let toAddFavs = _.difference(toAdd, projProcesses);
        user.<span class="cstat-no" title="statement not covered" >favorites[projectID].processes = projProcesses.concat(toAddFavs);</span>
        yield <span class="cstat-no" title="statement not covered" >r.table('users').get(userID).update({favorites: user.favorites});</span>
    }
    return yield <span class="cstat-no" title="statement not covered" >r.table('users').get(userID).without('admin', 'apikey', 'password');</span>
}
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >function* updateUserSettings(userId, settings) {</span></span>
    yield <span class="cstat-no" title="statement not covered" >r.table('users').get(userId).update(settings);</span>
    let user = yield <span class="cstat-no" title="statement not covered" >r.table('users').get(userId).without('admin', 'apikey', 'password');</span>
    return <span class="cstat-no" title="statement not covered" >{val: user};</span>
}
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >function* createPasswordResetRequest(user) {</span></span>
    let validate_uuid = yield <span class="cstat-no" title="statement not covered" >r.uuid();</span>
    return yield <span class="cstat-no" title="statement not covered" >setUserPasswordResetFlag(user.id, validate_uuid);</span>
}
&nbsp;
function* setUserPasswordResetFlag(userId, validate_uuid) {
    return yield r.table('users').get(userId).update({reset_password: true, validate_uuid: validate_uuid});
}
&nbsp;
function* clearUserPasswordResetFlag(userId) {
    return yield r.table('users').get(userId).replace(r.row.without('reset_password', 'validate_uuid'));
}
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >function* getUserForPasswordResetFromUuid(uuid) {</span></span></span>
    let results = yield <span class="cstat-no" title="statement not covered" >r.table('users')</span>
        .getAll(uuid, {index: 'validate_uuid'}).without('apikey', 'password');
    if (!<span class="cstat-no" title="statement not covered" >results.length) {</span>
        return <span class="cstat-no" title="statement not covered" >{error: "No validated user record. Please retry."};</span>
    }
    let user = results[0];
    return <span class="cstat-no" title="statement not covered" >{val: user};</span>
}
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >function* createUnverifiedAccount(account) {</span></span></span></span></span>
    let apikey = yield <span class="cstat-no" title="statement not covered" >r.uuid(),</span>
        user = new model.User(account.email, account.fullname, apikey.replace(/-/g, ''));
    user.<span class="cstat-no" title="statement not covered" >validate_uuid = yield <span class="cstat-no" title="statement not covered" >r.uuid();</span></span>
    let u = yield <span class="cstat-no" title="statement not covered" >r.table('users').get(account.email);</span>
    if (<span class="cstat-no" title="statement not covered" >u) {</span>
        return <span class="cstat-no" title="statement not covered" >{error: "User account already exists: " + account.email};</span>
    }
    let rv = yield <span class="cstat-no" title="statement not covered" >r.table('account_requests').insert(user, {returnChanges: true});</span>
    if (<span class="cstat-no" title="statement not covered" >rv.errors) {</span>
        return <span class="cstat-no" title="statement not covered" >{error: "Validation was already sent: " + account.email};</span>
    }
&nbsp;
    return <span class="cstat-no" title="statement not covered" >{val: rv.changes[0].new_val};</span>
}
&nbsp;
<span class="cstat-no" title="statement not covered" ><span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >function* getUserRegistrationFromUuid(uuid) {</span></span></span>
    let results = yield <span class="cstat-no" title="statement not covered" >r.table('account_requests').getAll(uuid, {index: 'validate_uuid'});</span>
    if (!<span class="cstat-no" title="statement not covered" >results.length) {</span>
        return <span class="cstat-no" title="statement not covered" >{error: "User validation record does not exists: " + uuid};</span>
    }
    let registration = results[0];
    delete <span class="cstat-no" title="statement not covered" >registration['password'];</span>
    delete <span class="cstat-no" title="statement not covered" >registration['apikey'];</span>
    return <span class="cstat-no" title="statement not covered" >{val: registration};</span>
}
&nbsp;
module.exports = {
    getUsers: getUsers,
    getAllUsersExternal,
    getUser: getUser,
    get: <span class="fstat-no" title="function not covered" >function(id, index) {</span>
        return <span class="cstat-no" title="statement not covered" >getSingle(r, 'users', id, index);</span>
    },
    updateProjectFavorites,
    updateUserSettings,
    createUnverifiedAccount,
    createPasswordResetRequest,
    getUserRegistrationFromUuid,
    setUserPasswordResetFlag,
    clearUserPasswordResetFlag,
    getUserForPasswordResetFromUuid
};</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Thu Aug 03 2017 13:23:18 GMT-0400 (EDT)
</div>
</div>
<script src="../../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../../sorter.js"></script>
</body>
</html>
